<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>萬用作文模板</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7BDSKB7YSY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 動畫效果 */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
    </style>
</head>
<body class="bg-[#F7F7F5] text-[#37352F] h-[100dvh] overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS (SVG) ---
        const Icons = {
            Book: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            FileText: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            Play: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Pause: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
            Square: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
            Eye: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            X: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            ToggleLeft: () => <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"/><circle cx="8" cy="12" r="3"/></svg>,
            ToggleRight: () => <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#EB5757" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"/><circle cx="16" cy="12" r="3"/></svg>,
            Translate: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 8l6 6"/><path d="M4 14h6"/><path d="M2 5h12"/><path d="M7 2v3"/><path d="M22 22l-5-10-5 10"/><path d="M14 18h6"/></svg>,
            ChevronDown: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9l6 6 6-6"/></svg>,
            ChevronUp: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
        };

        // --- 資料庫 ---
        const VOCAB_DB = {
            "prevalence": { kk: "[ˋprɛvələns]", pos: "n.", def: "流行；普及", ex: "The prevalence of smartphones is undeniable." },
            "indispensable": { kk: "[͵ɪndɪsˋpɛnsəb!]", pos: "adj.", def: "不可或缺的", ex: "Water is indispensable to life." },
            "contemplation": { kk: "[͵kɑntɛmˋpleʃən]", pos: "n.", def: "沉思；凝視", ex: "He sat in quiet contemplation of the view." },
            "evoke": { kk: "[ɪˋvok]", pos: "v.", def: "喚起；引起", ex: "The music evoked memories of her youth." },
            "lens": { kk: "[lɛnz]", pos: "n.", def: "鏡頭；視角", ex: "Try to look at the problem through a different lens." },
            "evident": { kk: "[ˋɛvədənt]", pos: "adj.", def: "明顯的", ex: "It is evident that you are tired." },
            "symbol": { kk: "[ˋsɪmb!]", pos: "n.", def: "象徵", ex: "The dove is a symbol of peace." },
            "unparalleled": { kk: "[ʌnˋpærə͵lɛld]", pos: "adj.", def: "無比的；空前的", ex: "This athlete has unparalleled skill." },
            "customization": { kk: "[͵kʌstəmɪˋzeʃən]", pos: "n.", def: "客製化", ex: "The software offers high customization." },
            "tailor": { kk: "[ˋtelɚ]", pos: "v.", def: "量身訂做；調整", ex: "We can tailor the program to your needs." },
            "superficial": { kk: "[͵supɚˋfɪʃəl]", pos: "adj.", def: "表面的；膚淺的", ex: "His injury was only superficial." },
            "phenomenon": { kk: "[fəˋnɑmə͵nɑn]", pos: "n.", def: "現象", ex: "Snow in July is a rare phenomenon." },
            "implications": { kk: "[͵ɪmplɪˋkeʃənz]", pos: "n.", def: "影響；暗示", ex: "We must consider the long-term implications." },
            "wary": { kk: "[ˋwɛrɪ]", pos: "adj.", def: "謹慎的；提防的", ex: "Be wary of strangers offering gifts." },
            "excessive": { kk: "[ɪkˋsɛsɪv]", pos: "adj.", def: "過度的", ex: "Excessive noise can damage hearing." },
            "indulgence": { kk: "[ɪnˋdʌldʒəns]", pos: "n.", def: "放縱；沈溺", ex: "Chocolate is my only indulgence." },
            "culinary": { kk: "[ˋkʌlɪ͵nɛrɪ]", pos: "adj.", def: "烹飪的", ex: "She is studying culinary arts." },
            "vibrancy": { kk: "[ˋvaɪbrənsɪ]", pos: "n.", def: "活力；生氣", ex: "The vibrancy of the city is exciting." },
            "propagates": { kk: "[ˋprɑpə͵gets]", pos: "v.", def: "傳播；繁殖", ex: "Rumors propagate quickly online." },
            "vulnerability": { kk: "[͵vʌlnərəˋbɪlətɪ]", pos: "n.", def: "脆弱性", ex: "He admitted his vulnerability." },
            "imminent": { kk: "[ˋɪmənənt]", pos: "adj.", def: "即將發生的", ex: "A storm is imminent." },
            "hypothetical": { kk: "[͵haɪpəˋθɛtɪk!]", pos: "adj.", def: "假設的", ex: "This is a hypothetical situation." },
            "garner": { kk: "[ˋgɑrnɚ]", pos: "v.", def: "獲得；收集", ex: "The movie garnered rave reviews." },
            "contend": { kk: "[kənˋtɛnd]", pos: "v.", def: "主張；競爭", ex: "I contend that this is the best option." },
            "imperative": { kk: "[ɪmˋpɛrətɪv]", pos: "adj.", def: "必要的；極重要的", ex: "It is imperative to act now." },
            "catalyst": { kk: "[ˋkætəlɪst]", pos: "n.", def: "催化劑；推手", ex: "The protest was a catalyst for change." },
            "recur": { kk: "[rɪˋkɝ]", pos: "v.", def: "重現；復發", ex: "The problem tends to recur." },
            "emergence": { kk: "[ɪˋmɝdʒəns]", pos: "n.", def: "出現；浮現", ex: "The emergence of AI changed everything." },
            "superstition": { kk: "[͵supɚˋstɪʃən]", pos: "n.", def: "迷信", ex: "It is a superstition to avoid black cats." },
            "suspicion": { kk: "[səˋspɪʃən]", pos: "n.", def: "懷疑", ex: "I have a suspicion that he is lying." },
            "desperate": { kk: "[ˋdɛspərɪt]", pos: "adj.", def: "絕望的；極度渴望的", ex: "They made a desperate attempt to escape." },
            "mortality": { kk: "[mɔrˋtælətɪ]", pos: "n.", def: "必死性；死亡率", ex: "Humans are aware of their mortality." },
            "cherish": { kk: "[ˋtʃɛrɪʃ]", pos: "v.", def: "珍惜", ex: "I cherish our time together." },
            "authentic": { kk: "[ɔˋθɛntɪk]", pos: "adj.", def: "道地的；真實的", ex: "This is authentic Italian food." },
            "convinced": { kk: "[kənˋvɪnst]", pos: "adj.", def: "確信的", ex: "I am convinced of his innocence." },
            "inevitably": { kk: "[ɪnˋɛvətəblɪ]", pos: "adv.", def: "不可避免地", ex: "Inevitably, it started to rain." },
            "threat": { kk: "[θrɛt]", pos: "n.", def: "威脅", ex: "Pollution poses a threat to nature." },
            "perspective": { kk: "[pɚˋspɛktɪv]", pos: "n.", def: "觀點", ex: "From my perspective, it looks fine." },
            "allure": { kk: "[əˋljʊr]", pos: "n.", def: "魅力；誘惑", ex: "The allure of the city is strong." },
            "inclusivity": { kk: "[͵ɪnkluˋsɪvətɪ]", pos: "n.", def: "包容性", ex: "We promote inclusivity in the workplace." },
            "dynamic": { kk: "[daɪˋnæmɪk]", pos: "adj.", def: "動態的；充滿活力的", ex: "The market is very dynamic." },
            "unflagging": { kk: "[ʌnˋflægɪŋ]", pos: "adj.", def: "不懈的", ex: "Her unflagging support helped me." },
            "experiential": { kk: "[ɪk͵spɪrɪˋɛnʃəl]", pos: "adj.", def: "經驗的；體驗式的", ex: "The museum offers experiential learning." }
        };

        const FOOTNOTE_DB = {
            1: ["the prevalence of smartphone usage", "the fascinating culture of queuing", "the looming shadow of doomsday predictions"],
            2: ["people are glued to screens", "crowds flock to new restaurants"],
            3: ["my own habits", "the predicted disaster"],
            4: ["the warmth of human kindness and the convenient, sleepless vibrancy of our night markets", "how easily fear spreads, affecting even tourism and daily decisions"],
            5: ["our anxiety", "our digital dependence", "the vibrancy of Taiwanese society"],
            6: ["my health", "how we should live", "marketing Taiwan"],
            7: ["the pros and cons", "the possibility of the end of the world"],
            8: ["while they are probably not scientifically accurate, they are a valuable philosophical reminder of our mortality"],
            9: ["mitigate health risks", "promote our culture", "spend my final days"],
            10: ["launch social media campaigns that invite influencers to 'live a day as a local,' immersing them in the authentic warmth and culinary delights we offer"],
            11: ["this cultural promotion", "this doomsday scenario"],
            12: ["prioritize our time", "cherish our identity"]
        };

        const FORMULA_PARAGRAPHS = [
            `[P1]
In the context of modern existence, few subjects evoke as much contemplation as 描述主題的名詞[1]. Whether viewed through the lens of social trends or personal experience, it is evident that 明確細節的句子[2]. Specifically, regarding 明確的細節名詞[3], one cannot help but notice 描述細節的名詞[4]. This phenomenon is not merely superficial; it serves as a mirror reflecting 深刻的意義(名詞)[5].`,
            
            `[P2]
While the aforementioned observations provide the context, a deeper reflection reveals significant implications regarding 核心問題(名詞)[6]. If I were to evaluate 問題/優缺點/可能性等(名詞)[7], I would contend that 自己的選擇或立場(句子)[8]. Consequently, to 目的(原形動詞)[9], my approach would be to 打算做的行動(原形動詞)[10]. Ultimately, 主題(問題、現象)名詞[11] acts as a catalyst, compelling us to rethink how we 結論(動詞)[12].`
        ];

        const ESSAYS_DATA = [
            {
                id: 1,
                title: "範文 1: Hand-shaken Drinks",
                prompt: "提示：現代臺灣人或多或少都會買手搖飲來喝,普遍認為手搖飲很方便且能客製化,故成為許多人日常生活的一部分。請以此為題,寫一篇英文作文。第一段請說明手搖飲在臺灣流行的原因,第二段請敘述你自己或親友對手搖飲的看法。",
                content: "In the context of modern existence, few subjects evoke as much contemplation as the prevalence of hand-shaken drinks in Taiwan. Whether viewed through the lens of Taiwanese food culture or daily habit, it is evident that carrying a cup of bubble tea has become a symbol of local life. Specifically, regarding the reasons behind their immense popularity, one cannot help but notice the unparalleled convenience and the high degree of customization available, allowing consumers to tailor sweetness levels and toppings to their exact preferences. This phenomenon is not merely superficial; it serves as a mirror reflecting the Taiwanese pursuit of 'tiny happiness' and the desire for personalized comfort amidst a fast-paced lifestyle.\n\nWhile the aforementioned observations provide the context, a deeper reflection reveals significant implications regarding the balance between psychological satisfaction and physical well-being. If I were to evaluate my family's perspective on these beverages, I would contend that while we acknowledge them as a delightful treat that relieves stress, we remain wary of the potential health risks associated with excessive sugar intake. Consequently, to enjoy these drinks without compromising our health, my approach would be to treat them as an occasional indulgence rather than a daily necessity, and to opt for sugar-free tea or fresh fruit alternatives. Ultimately, the hand-shaken drink culture acts as a catalyst, compelling us to rethink how we make conscious dietary choices in an environment filled with temptation.",
                translation: "在現代生存的背景下，很少有主題能像台灣手搖飲料的普及那樣引起如此多的沉思。無論是透過台灣飲食文化還是日常習慣的視角來看，很明顯地，拿著一杯珍珠奶茶已經成為在地生活的象徵。具體來說，關於其極度受歡迎的原因，人們不得不注意到其無與倫比的便利性和高度的客製化，讓消費者能夠根據自己的確切喜好調整甜度和配料。這種現象不僅僅是表面的；它就像一面鏡子，反映了台灣人對「小確幸」的追求，以及在快節奏的生活方式中對個人化慰藉的渴望。\n\n雖然上述觀察提供了背景，但更深入的反思揭示了關於心理滿足與身體健康之間平衡的重大影響。如果要評估我們家對這些飲料的看法，我會主張雖然我們承認它們是緩解壓力的愉快享受，但我們仍然對與攝入過多糖分相關的潛在健康風險保持警惕。因此，為了在不損害健康的情況下享受這些飲料，我的做法是將它們視為偶爾的放縱，而不是日常必需品，並選擇無糖茶或新鮮水果替代品。最終，手搖飲料文化充當了催化劑，迫使我們重新思考如何在充滿誘惑的環境中做出有意識的飲食選擇。"
            },
            {
                id: 2,
                title: "範文 2: Pride of Taiwan",
                prompt: "提示：身為臺灣的一份子，臺灣最讓你感到驕傲的是什麼？請以此為題，寫一篇英文作文，談臺灣最讓你引以為榮的二個面向或事物（例如：人、事、物、文化、制度等）。第一段描述這二個面向或事物，並說明它們為何讓你引以為榮；第二段則說明你認為可以用什麼方式來介紹或行銷這些臺灣特色，讓世人更了解臺灣。",
                content: "In the context of modern existence, few subjects evoke as much contemplation as the unique charm of my homeland, Taiwan. Whether viewed through the lens of a local resident or an international traveler, it is evident that this island possesses a distinct allure that captivates the soul. Specifically, regarding what makes me proudest, one cannot help but notice the warmth of human kindness and the convenient, sleepless vibrancy of our night markets. This phenomenon is not merely superficial; it serves as a mirror reflecting Taiwan's spirit of inclusivity and its dynamic, unflagging energy.\n\nWhile the aforementioned observations provide the context, a deeper reflection reveals significant implications regarding how we can project this soft power to the global stage. If I were to evaluate the best strategy to introduce these features, I would contend that experiential storytelling is far more powerful than mere slogans. Consequently, to market Taiwan to the world, my approach would be to launch social media campaigns that invite influencers to 'live a day as a local,' immersing them in the authentic warmth and culinary delights we offer. Ultimately, this cultural promotion acts as a catalyst, compelling us to rethink how we define our identity and share our treasures with the global community.",
                translation: "在現代生存的背景下，很少有主題能像我家鄉——台灣——的獨特魅力那樣引起如此多的沉思。無論是透過當地居民還是國際旅客的視角來看，很明顯地，這座島嶼擁有獨特的吸引力，能迷住靈魂。具體來說，關於讓我最感驕傲的事物，人們不得不注意到濃厚的人情味以及便利、不夜城的夜市活力。這種現象不僅僅是表面的；它就像一面鏡子，反映了台灣的包容精神及其充滿活力、不懈的能量。\n\n雖然上述觀察提供了背景，但更深入的反思揭示了關於我們如何將這種軟實力投射到全球舞台的重大影響。如果要評估介紹這些特色的最佳策略，我會主張體驗式的故事講述遠比單純的口號強大得多。因此，為了向世界行銷台灣，我的做法是發起社群媒體活動，邀請網紅「像當地人一樣生活一天」，讓他們沉浸在我們提供的真實溫暖和美食佳餚中。最終，這種文化推廣充當了催化劑，迫使我們重新思考如何定義我們的身份並與全球社群分享我們的珍寶。"
            },
            {
                id: 3,
                title: "範文 3: Doomsday Prediction",
                prompt: "提示：每隔一陣子總會出現末日預言(doomsday prediction),如日本有位漫畫家預言 2025 年 7 月 5 日會發生強震重創日本和鄰近國家,此預言引發恐慌,甚至影響各國遊客在該月到日本旅遊的意願。你相信這種末日預言嗎?請寫一篇英文作文,文分兩段,第一段陳述你對末日預言的看法(是迷信還是值得參考), 第二段說明若世界末日真的到來,你會如何度過。",
                content: "In the context of modern existence, few subjects evoke as much contemplation as the recurring emergence of doomsday predictions. Whether viewed through the lens of superstition or scientific caution, it is evident that such predictions often trigger a mix of panic and suspicion among the public. Specifically, regarding the prediction of a massive earthquake in July 2025, one cannot help but notice how easily fear propagates, affecting even tourism and daily decisions. This phenomenon is not merely superficial; it serves as a mirror reflecting humanity's inherent vulnerability and our desperate need for certainty in an unpredictable world.\n\nWhile the aforementioned observations provide the context, a deeper reflection reveals significant implications regarding how we perceive the value of our limited time. If I were to evaluate the credibility of these prophecies, I would contend that while they are probably not scientifically accurate, they are a valuable philosophical reminder of our mortality. Consequently, if the end of the world were truly imminent, my approach would not be to give in to despair, but to spend my final moments embracing my loved ones and expressing gratitude for the life I have lived. Ultimately, this doomsday scenario acts as a catalyst, compelling us to rethink how we cherish every present moment rather than fearing a hypothetical future.",
                translation: "在現代生存的背景下，很少有主題能像反覆出現的末日預言那樣引起如此多的沉思。無論是透過迷信還是科學謹慎的視角來看，很明顯地，這類預言往往在公眾中引發恐慌與猜疑的混合情緒。具體來說，關於 2025 年 7 月發生大地震的預言，人們不得不注意到恐懼是多麼容易傳播，甚至影響旅遊和日常決策。這種現象不僅僅是表面的；它就像一面鏡子，反映了人類固有的脆弱性以及我們在不可預測的世界中對確定性的迫切需求。\n\n雖然上述觀察提供了背景，但更深入的反思揭示了關於我們如何看待有限時間價值的重大影響。如果要評估這些預言的可信度，我會主張雖然它們在科學上可能不準確，但它們是關於我們必死性的寶貴哲學提醒。因此，如果世界末日真的迫在眉睫，我的做法不是屈服於絕望，而是花最後的時刻擁抱我的摯愛，並對我所過的生活表達感激。最終，這個末日情境充當了催化劑，迫使我們重新思考如何珍惜當下的每一刻，而不是恐懼假設的未來。"
            }
        ];

        // --- 核心元件 ---

        const useAudioPlayer = (text) => {
            const [state, setState] = useState('idle'); 
            const audioRef = useRef(null);
            const synthRef = useRef(window.speechSynthesis);

            const stop = () => {
                if (audioRef.current) { audioRef.current.pause(); audioRef.current.currentTime = 0; }
                if (synthRef.current.speaking || synthRef.current.paused) { synthRef.current.cancel(); }
                setState('idle');
            };

            const play = async () => {
                stop();
                setState('playing');
                try {
                    const encoded = encodeURIComponent(text);
                    const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=en&q=${encoded}`;
                    const audio = new Audio(url);
                    audioRef.current = audio;
                    audio.onended = () => setState('idle');
                    audio.onerror = () => playFallback();
                    await audio.play();
                } catch (e) {
                    playFallback();
                }
            };

            const playFallback = () => {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US'; u.rate = 0.9;
                u.onend = () => setState('idle');
                synthRef.current.speak(u);
            };

            const pause = () => {
                if (audioRef.current && !audioRef.current.paused) { audioRef.current.pause(); setState('paused'); }
                else if (synthRef.current.speaking) { synthRef.current.pause(); setState('paused'); }
            };

            const resume = () => {
                 if (audioRef.current && audioRef.current.paused) { audioRef.current.play(); setState('playing'); }
                else if (synthRef.current.paused) { synthRef.current.resume(); setState('playing'); }
                else { play(); }
            }

            return { state, play, pause, resume, stop };
        };

        const BottomSheet = ({ data, type, onClose, isQuizMode }) => {
            const { state, play, pause, resume, stop } = useAudioPlayer(type === 'vocab' ? `${data.word}. ${data.ex}` : '');
            const [isRevealed, setIsRevealed] = useState(false);

            useEffect(() => { setIsRevealed(false); return () => stop(); }, [data.id || data.word]);
            const showHidden = isQuizMode && type === 'vocab' && !isRevealed;

            return (
                <div className="fixed inset-0 z-50 flex items-end justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-black/40 animate-fade-in pointer-events-auto" onClick={onClose}></div>
                    <div className="bg-white w-full rounded-t-2xl p-6 pb-12 shadow-[0_-5px_20px_rgba(0,0,0,0.15)] animate-slide-up pointer-events-auto relative max-h-[80vh] overflow-y-auto">
                        <div className="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 p-2"><Icons.X /></button>

                        <div className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">
                            {type === 'vocab' ? 'Vocabulary' : 'Formula Examples'}
                        </div>

                        {type === 'footnote' && (
                            <div className="space-y-3">
                                {data.map((ex, i) => (
                                    <div key={i} className="p-3 bg-blue-50 rounded-lg text-base text-gray-800 border-l-4 border-blue-400">
                                        {ex}
                                    </div>
                                ))}
                            </div>
                        )}

                        {type === 'vocab' && showHidden && (
                            <div className="text-center py-6">
                                <div className="text-gray-500 mb-2">{data.pos}</div>
                                <div className="font-bold text-xl mb-6">{data.def}</div>
                                <button onClick={() => setIsRevealed(true)}
                                    className="flex items-center justify-center gap-2 w-full py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg shadow-blue-200 active:scale-95 transition-transform">
                                    <Icons.Eye /> 揭曉答案
                                </button>
                            </div>
                        )}

                        {type === 'vocab' && !showHidden && (
                            <div>
                                <div className="flex justify-between items-end mb-2">
                                    <h3 className="text-3xl font-bold text-gray-900 leading-none">{data.word}</h3>
                                    <span className="font-mono text-gray-500">{data.kk}</span>
                                </div>
                                <div className="flex items-center gap-2 mb-6">
                                    <span className="text-xs font-bold bg-gray-100 px-2 py-1 rounded text-gray-600">{data.pos}</span>
                                    <span className="text-lg text-gray-800 font-medium">{data.def}</span>
                                </div>
                                <div className="flex items-center gap-3 mb-6 bg-gray-50 p-2 pr-4 rounded-full w-max border border-gray-100">
                                    <button onClick={state === 'playing' ? pause : (state === 'paused' ? resume : play)} 
                                        className="w-10 h-10 flex items-center justify-center bg-white shadow rounded-full text-blue-600 active:bg-gray-50">
                                        {state === 'playing' ? <Icons.Pause /> : <Icons.Play />}
                                    </button>
                                    <button onClick={stop} className="p-2 text-gray-400 hover:text-red-500"><Icons.Square /></button>
                                    <div className="h-4 w-[1px] bg-gray-300 mx-1"></div>
                                    <span className="text-xs font-medium text-blue-900">
                                        {state === 'playing' ? 'Playing...' : 'Listen'}
                                    </span>
                                </div>
                                <div className="text-base text-gray-600 italic border-l-2 border-gray-300 pl-3 leading-relaxed">
                                    "{data.ex}"
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const TextParser = ({ text, onActivate, activeId, isQuizMode }) => {
            const parts = text.split(/(\[\d+\]|[\u4e00-\u9fa5]+[a-zA-Z0-9\(\)\/]*|[\s\.,;!?()]+)/g).filter(Boolean);

            return (
                <p className="leading-relaxed text-[17px] text-gray-800 font-normal tracking-wide">
                    {parts.map((part, index) => {
                        // Footnote
                        if (/^\[\d+\]$/.test(part)) {
                            const id = parseInt(part.replace(/[\[\]]/g, ''));
                            return (
                                <button key={index} 
                                    onClick={(e) => { e.stopPropagation(); onActivate('footnote', id); }}
                                    className="inline-flex items-center justify-center min-w-[18px] h-[18px] ml-1 align-top text-[10px] font-bold bg-[#EB5757]/10 text-[#EB5757] rounded active:bg-[#EB5757] active:text-white transition-colors">
                                    {id}
                                </button>
                            );
                        }
                        // Chinese Placeholder
                        if (/[\u4e00-\u9fa5]/.test(part)) {
                            return <span key={index} className="text-gray-400 mx-1 border-b border-dashed border-gray-300">{part}</span>;
                        }
                        // Vocab Check
                        const lower = part.toLowerCase();
                        if (VOCAB_DB[lower]) {
                            const isActive = activeId === `vocab-${lower}`;
                            if (isQuizMode) {
                                return (
                                    <span key={index} onClick={(e) => { e.stopPropagation(); onActivate('vocab', lower); }}
                                        className="border-b-2 border-[#EB5757] bg-[#EB5757]/5 px-1 mx-0.5 text-transparent active:bg-[#EB5757]/20 transition-colors cursor-pointer">
                                        {part}
                                    </span>
                                );
                            }
                            return (
                                <span key={index} onClick={(e) => { e.stopPropagation(); onActivate('vocab', lower); }}
                                    className={`px-1 mx-0.5 rounded transition-colors cursor-pointer ${isActive ? 'bg-blue-200 text-blue-900' : 'bg-[#E3E2E0] active:bg-blue-100'}`}>
                                    {part}
                                </span>
                            );
                        }
                        return <span key={index}>{part}</span>;
                    })}
                </p>
            );
        };

        // 新增：獨立的 Essay 卡片元件，處理翻譯切換狀態
        const EssayCard = ({ essay, onActivate, activePopoverKey, isQuizMode }) => {
            const [showTrans, setShowTrans] = useState(false);

            return (
                <div>
                    <h2 className="text-xl font-bold mb-2 text-gray-900 leading-tight">
                        {essay.title}
                    </h2>
                    
                    <div className="bg-gray-100 p-3 rounded-lg mb-4 text-sm text-gray-600 leading-relaxed border-l-4 border-gray-300">
                        {essay.prompt}
                    </div>
                    
                    {/* 英文原文區塊 */}
                    <div className="mb-4">
                        <TextParser text={essay.content} onActivate={onActivate} activeId={activePopoverKey} isQuizMode={isQuizMode} />
                    </div>

                    {/* 翻譯切換按鈕 */}
                    <button 
                        onClick={() => setShowTrans(!showTrans)}
                        className="flex items-center gap-1.5 text-xs font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-full transition-colors mb-4">
                        <Icons.Translate />
                        {showTrans ? '隱藏中文翻譯' : '查看中文翻譯'}
                        {showTrans ? <Icons.ChevronUp /> : <Icons.ChevronDown />}
                    </button>

                    {/* 中文翻譯區塊 (展開效果) */}
                    {showTrans && (
                        <div className="bg-[#F3F4F6] p-4 rounded-xl text-[15px] leading-relaxed text-gray-700 animate-fade-in border border-gray-200">
                            {essay.translation.split('\n\n').map((p, i) => (
                                <p key={i} className={i > 0 ? 'mt-4' : ''}>{p}</p>
                            ))}
                        </div>
                    )}
                    
                    <div className="h-px bg-gray-100 my-8"></div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('formula');
            const [activePopover, setActivePopover] = useState(null); 
            const [isQuizMode, setIsQuizMode] = useState(false);

            const handleActivate = (type, id) => setActivePopover({ type, id, key: `${type}-${id}` });
            const closePopover = () => setActivePopover(null);

            return (
                <div className="flex flex-col h-full bg-white relative">
                    
                    {/* Header */}
                    <div className="bg-white/90 backdrop-blur border-b border-gray-200 px-4 py-3 flex justify-between items-center z-20 shrink-0 safe-top gap-3">
                        <div className="font-bold text-base text-gray-800 truncate flex-1">
                            萬用作文模板：論述與個人意見版
                        </div>
                        
                        <div className="flex items-center gap-2 bg-gray-100 rounded-full pl-3 pr-2 py-1 cursor-pointer shrink-0" onClick={() => setIsQuizMode(!isQuizMode)}>
                            <span className={`text-[10px] font-bold tracking-wider ${!isQuizMode ? 'text-blue-600' : 'text-gray-400'}`}>
                                STUDY
                            </span>
                            <div className="transition-colors text-gray-400">
                                {isQuizMode ? <Icons.ToggleRight /> : <Icons.ToggleLeft />}
                            </div>
                            <span className={`text-[10px] font-bold tracking-wider ${isQuizMode ? 'text-[#EB5757]' : 'text-gray-400'}`}>
                                QUIZ
                            </span>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto overflow-x-hidden pb-24 px-5 pt-6 hide-scrollbar bg-white">
                        {activeTab === 'formula' && (
                            <div className="animate-fade-in">
                                <div className="mb-8 bg-blue-50/80 p-4 rounded-xl border border-blue-100">
                                    <div className="text-xs font-bold text-blue-400 uppercase tracking-widest mb-2">Instructions</div>
                                    <div className="space-y-1 text-sm text-blue-900">
                                        <p><span className="font-bold">Step 1:</span> 閱讀樣板 (不用背樣板) </p>
                                        <p><span className="font-bold">Step 2:</span> 閱讀範文</p>
                                        <p><span className="font-bold">Step 3:</span> <span className="underline decoration-blue-300">全文背誦</span>一篇範文 ⭐範文有上下文，比公式好背，背熟後自然能靈活運用。</p>
                                    </div>
                                </div>

                                <h2 className="text-2xl font-bold mb-6 text-gray-900">萬用作文模版</h2>
                                {FORMULA_PARAGRAPHS.map((para, i) => (
                                    <div key={i}>
                                        <TextParser text={para} onActivate={handleActivate} activeId={activePopover?.key} isQuizMode={isQuizMode} />
                                        {i < FORMULA_PARAGRAPHS.length - 1 && <div className="h-6"></div>}
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'essays' && (
                            <div className="animate-fade-in space-y-12">
                                {ESSAYS_DATA.map(essay => (
                                    <EssayCard 
                                        key={essay.id} 
                                        essay={essay} 
                                        onActivate={handleActivate} 
                                        activePopoverKey={activePopover?.key} 
                                        isQuizMode={isQuizMode} 
                                    />
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Nav */}
                    <nav className="shrink-0 bg-white border-t border-gray-200 safe-bottom pb-safe z-30">
                        <div className="flex justify-around items-center h-16">
                            <button onClick={() => setActiveTab('formula')} 
                                className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${activeTab === 'formula' ? 'text-blue-600' : 'text-gray-400'}`}>
                                <Icons.Book />
                                <span className="text-[10px] font-medium">Formula</span>
                            </button>
                            <button onClick={() => setActiveTab('essays')} 
                                className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${activeTab === 'essays' ? 'text-blue-600' : 'text-gray-400'}`}>
                                <Icons.FileText />
                                <span className="text-[10px] font-medium">Essays</span>
                            </button>
                        </div>
                    </nav>

                    {/* Popover */}
                    {activePopover && (
                        <BottomSheet 
                            data={activePopover.type === 'vocab' 
                                ? { ...VOCAB_DB[activePopover.id], word: activePopover.id } 
                                : FOOTNOTE_DB[activePopover.id]} 
                            type={activePopover.type} 
                            onClose={closePopover} 
                            isQuizMode={isQuizMode} 
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
