<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Essay Coach</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX'); // 請將 G-XXXXXXXXXX 換成您的 ID
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        /* 自定義滾動條 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #D1D5DB; }
    </style>
</head>
<body class="bg-[#F7F7F5] text-[#37352F] h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICON 資源 (SVG Strings) ---
        const Icons = {
            BookOpen: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Pause: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
            Square: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            ToggleLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"/><circle cx="8" cy="12" r="3"/></svg>,
            ToggleRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#EB5757" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"/><circle cx="16" cy="12" r="3"/></svg>
        };

        // --- 資料庫 (Data Source) ---
        const VOCAB_DB = {
            "prevalence": { kk: "[ˋprɛvələns]", pos: "n.", def: "流行；普及", ex: "The prevalence of smartphones is undeniable." },
            "indispensable": { kk: "[͵ɪndɪsˋpɛnsəb!]", pos: "adj.", def: "不可或缺的", ex: "Water is indispensable to life." },
            "contemplation": { kk: "[͵kɑntɛmˋpleʃən]", pos: "n.", def: "沉思；凝視", ex: "He sat in quiet contemplation of the view." },
            "evoke": { kk: "[ɪˋvok]", pos: "v.", def: "喚起；引起", ex: "The music evoked memories of her youth." },
            "lens": { kk: "[lɛnz]", pos: "n.", def: "鏡頭；視角", ex: "Try to look at the problem through a different lens." },
            "evident": { kk: "[ˋɛvədənt]", pos: "adj.", def: "明顯的", ex: "It is evident that you are tired." },
            "symbol": { kk: "[ˋsɪmb!]", pos: "n.", def: "象徵", ex: "The dove is a symbol of peace." },
            "unparalleled": { kk: "[ʌnˋpærə͵lɛld]", pos: "adj.", def: "無比的；空前的", ex: "This athlete has unparalleled skill." },
            "customization": { kk: "[͵kʌstəmɪˋzeʃən]", pos: "n.", def: "客製化", ex: "The software offers high customization." },
            "tailor": { kk: "[ˋtelɚ]", pos: "v.", def: "量身訂做；調整", ex: "We can tailor the program to your needs." },
            "superficial": { kk: "[͵supɚˋfɪʃəl]", pos: "adj.", def: "表面的；膚淺的", ex: "His injury was only superficial." },
            "phenomenon": { kk: "[fəˋnɑmə͵nɑn]", pos: "n.", def: "現象", ex: "Snow in July is a rare phenomenon." },
            "implications": { kk: "[͵ɪmplɪˋkeʃənz]", pos: "n.", def: "影響；暗示", ex: "We must consider the long-term implications." },
            "wary": { kk: "[ˋwɛrɪ]", pos: "adj.", def: "謹慎的；提防的", ex: "Be wary of strangers offering gifts." },
            "excessive": { kk: "[ɪkˋsɛsɪv]", pos: "adj.", def: "過度的", ex: "Excessive noise can damage hearing." },
            "indulgence": { kk: "[ɪnˋdʌldʒəns]", pos: "n.", def: "放縱；沈溺", ex: "Chocolate is my only indulgence." },
            "culinary": { kk: "[ˋkʌlɪ͵nɛrɪ]", pos: "adj.", def: "烹飪的", ex: "She is studying culinary arts." },
            "vibrancy": { kk: "[ˋvaɪbrənsɪ]", pos: "n.", def: "活力；生氣", ex: "The vibrancy of the city is exciting." },
            "propagates": { kk: "[ˋprɑpə͵gets]", pos: "v.", def: "傳播；繁殖", ex: "Rumors propagate quickly online." },
            "vulnerability": { kk: "[͵vʌlnərəˋbɪlətɪ]", pos: "n.", def: "脆弱性", ex: "He admitted his vulnerability." },
            "imminent": { kk: "[ˋɪmənənt]", pos: "adj.", def: "即將發生的", ex: "A storm is imminent." },
            "hypothetical": { kk: "[͵haɪpəˋθɛtɪk!]", pos: "adj.", def: "假設的", ex: "This is a hypothetical situation." },
            "garner": { kk: "[ˋgɑrnɚ]", pos: "v.", def: "獲得；收集", ex: "The movie garnered rave reviews." },
            "contend": { kk: "[kənˋtɛnd]", pos: "v.", def: "主張；競爭", ex: "I contend that this is the best option." },
            "imperative": { kk: "[ɪmˋpɛrətɪv]", pos: "adj.", def: "必要的；極重要的", ex: "It is imperative to act now." },
            "catalyst": { kk: "[ˋkætəlɪst]", pos: "n.", def: "催化劑；推手", ex: "The protest was a catalyst for change." },
            "recur": { kk: "[rɪˋkɝ]", pos: "v.", def: "重現；復發", ex: "The problem tends to recur." },
            "emergence": { kk: "[ɪˋmɝdʒəns]", pos: "n.", def: "出現；浮現", ex: "The emergence of AI changed everything." },
            "superstition": { kk: "[͵supɚˋstɪʃən]", pos: "n.", def: "迷信", ex: "It is a superstition to avoid black cats." },
            "suspicion": { kk: "[səˋspɪʃən]", pos: "n.", def: "懷疑", ex: "I have a suspicion that he is lying." },
            "desperate": { kk: "[ˋdɛspərɪt]", pos: "adj.", def: "絕望的；極度渴望的", ex: "They made a desperate attempt to escape." },
            "mortality": { kk: "[mɔrˋtælətɪ]", pos: "n.", def: "必死性；死亡率", ex: "Humans are aware of their mortality." },
            "cherish": { kk: "[ˋtʃɛrɪʃ]", pos: "v.", def: "珍惜", ex: "I cherish our time together." },
            "authentic": { kk: "[ɔˋθɛntɪk]", pos: "adj.", def: "道地的；真實的", ex: "This is authentic Italian food." },
            "convinced": { kk: "[kənˋvɪnst]", pos: "adj.", def: "確信的", ex: "I am convinced of his innocence." },
            "inevitably": { kk: "[ɪnˋɛvətəblɪ]", pos: "adv.", def: "不可避免地", ex: "Inevitably, it started to rain." },
            "threat": { kk: "[θrɛt]", pos: "n.", def: "威脅", ex: "Pollution poses a threat to nature." },
            "perspective": { kk: "[pɚˋspɛktɪv]", pos: "n.", def: "觀點", ex: "From my perspective, it looks fine." },
            "allure": { kk: "[əˋljʊr]", pos: "n.", def: "魅力；誘惑", ex: "The allure of the city is strong." },
            "inclusivity": { kk: "[͵ɪnkluˋsɪvətɪ]", pos: "n.", def: "包容性", ex: "We promote inclusivity in the workplace." },
            "dynamic": { kk: "[daɪˋnæmɪk]", pos: "adj.", def: "動態的；充滿活力的", ex: "The market is very dynamic." },
            "unflagging": { kk: "[ʌnˋflægɪŋ]", pos: "adj.", def: "不懈的", ex: "Her unflagging support helped me." },
            "experiential": { kk: "[ɪk͵spɪrɪˋɛnʃəl]", pos: "adj.", def: "經驗的；體驗式的", ex: "The museum offers experiential learning." }
        };

        const FOOTNOTE_DB = {
            1: ["the prevalence of smartphone usage", "the fascinating culture of queuing", "the looming shadow of doomsday predictions"],
            2: ["people are glued to screens", "crowds flock to new restaurants"],
            3: ["my own habits", "the predicted disaster"],
            4: ["the warmth of human kindness and the convenient, sleepless vibrancy of our night markets", "how easily fear spreads, affecting even tourism and daily decisions"],
            5: ["our anxiety", "our digital dependence", "the vibrancy of Taiwanese society"],
            6: ["my health", "how we should live", "marketing Taiwan"],
            7: ["the pros and cons", "the possibility of the end of the world"],
            8: ["while they are probably not scientifically accurate, they are a valuable philosophical reminder of our mortality"],
            9: ["mitigate health risks", "promote our culture", "spend my final days"],
            10: ["launch social media campaigns that invite influencers to 'live a day as a local,' immersing them in the authentic warmth and culinary delights we offer"],
            11: ["this cultural promotion", "this doomsday scenario"],
            12: ["prioritize our time", "cherish our identity"]
        };

        const FORMULA_TEXT = `[P1]
In the context of modern existence, few subjects evoke as much contemplation as 描述主題的名詞[1]. Whether viewed through the lens of social trends or personal experience, it is evident that 明確細節的句子[2]. Specifically, regarding 明確的細節名詞[3], one cannot help but notice 描述細節的名詞[4]. This phenomenon is not merely superficial; it serves as a mirror reflecting 深刻的意義(名詞)[5].

[P2]
While the aforementioned observations provide the context, a deeper reflection reveals significant implications regarding 核心問題(名詞)[6]. If I were to evaluate 問題/優缺點/可能性等(名詞)[7], I would contend that 自己的選擇或立場(句子)[8]. Consequently, to 目的(原形動詞)[9], my approach would be to 打算做的行動(原形動詞)[10]. Ultimately, 主題(問題、現象)名詞[11] acts as a catalyst, compelling us to rethink how we 結論(動詞)[12].`;

        const ESSAYS_DATA = [
            {
                id: 1,
                title: "範文 1: Hand-shaken Drinks",
                content: "In the context of modern existence, few subjects evoke as much contemplation as the prevalence of hand-shaken drinks in Taiwan. Whether viewed through the lens of Taiwanese food culture or daily habit, it is evident that carrying a cup of bubble tea has become a symbol of local life. Specifically, regarding the reasons behind their immense popularity, one cannot help but notice the unparalleled convenience and the high degree of customization available, allowing consumers to tailor sweetness levels and toppings to their exact preferences. This phenomenon is not merely superficial; it serves as a mirror reflecting the Taiwanese pursuit of 'tiny happiness' and the desire for personalized comfort amidst a fast-paced lifestyle.\n\nWhile the aforementioned observations provide the context, a deeper reflection reveals significant implications regarding the balance between psychological satisfaction and physical well-being. If I were to evaluate my family's perspective on these beverages, I would contend that while we acknowledge them as a delightful treat that relieves stress, we remain wary of the potential health risks associated with excessive sugar intake. Consequently, to enjoy these drinks without compromising our health, my approach would be to treat them as an occasional indulgence rather than a daily necessity, and to opt for sugar-free tea or fresh fruit alternatives. Ultimately, the hand-shaken drink culture acts as a catalyst, compelling us to rethink how we make conscious dietary choices in an environment filled with temptation."
            },
            {
                id: 2,
                title: "範文 2: Pride of Taiwan",
                content: "In the context of modern existence, few subjects evoke as much contemplation as the unique charm of my homeland, Taiwan. Whether viewed through the lens of a local resident or an international traveler, it is evident that this island possesses a distinct allure that captivates the soul. Specifically, regarding what makes me proudest, one cannot help but notice the warmth of human kindness and the convenient, sleepless vibrancy of our night markets. This phenomenon is not merely superficial; it serves as a mirror reflecting Taiwan's spirit of inclusivity and its dynamic, unflagging energy.\n\nWhile the aforementioned observations provide the context, a deeper reflection reveals significant implications regarding how we can project this soft power to the global stage. If I were to evaluate the best strategy to introduce these features, I would contend that experiential storytelling is far more powerful than mere slogans. Consequently, to market Taiwan to the world, my approach would be to launch social media campaigns that invite influencers to 'live a day as a local,' immersing them in the authentic warmth and culinary delights we offer. Ultimately, this cultural promotion acts as a catalyst, compelling us to rethink how we define our identity and share our treasures with the global community."
            },
            {
                id: 3,
                title: "範文 3: Doomsday Prediction",
                content: "In the context of modern existence, few subjects evoke as much contemplation as the recurring emergence of doomsday predictions. Whether viewed through the lens of superstition or scientific caution, it is evident that such predictions often trigger a mix of panic and suspicion among the public. Specifically, regarding the prediction of a massive earthquake in July 2025, one cannot help but notice how easily fear propagates, affecting even tourism and daily decisions. This phenomenon is not merely superficial; it serves as a mirror reflecting humanity's inherent vulnerability and our desperate need for certainty in an unpredictable world.\n\nWhile the aforementioned observations provide the context, a deeper reflection reveals significant implications regarding how we perceive the value of our limited time. If I were to evaluate the credibility of these prophecies, I would contend that while they are probably not scientifically accurate, they are a valuable philosophical reminder of our mortality. Consequently, if the end of the world were truly imminent, my approach would not be to give in to despair, but to spend my final moments embracing my loved ones and expressing gratitude for the life I have lived. Ultimately, this doomsday scenario acts as a catalyst, compelling us to rethink how we cherish every present moment rather than fearing a hypothetical future."
            }
        ];

        // --- 元件 (Components) ---
        
        // Audio Player Hook
        const useAudioPlayer = (text) => {
            const [state, setState] = useState('idle'); // idle, playing, paused
            const audioRef = useRef(null);
            const synthRef = useRef(window.speechSynthesis);
            const utteranceRef = useRef(null);

            const stop = () => {
                if (audioRef.current) {
                    audioRef.current.pause();
                    audioRef.current.currentTime = 0;
                }
                if (synthRef.current.speaking || synthRef.current.paused) {
                    synthRef.current.cancel();
                }
                setState('idle');
            };

            const play = async () => {
                stop(); // Reset previous
                setState('playing');

                // Try Google TTS First
                try {
                    // Encode only standard chars to avoid URL issues
                    const encoded = encodeURIComponent(text);
                    const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=en&q=${encoded}`;
                    const audio = new Audio(url);
                    audioRef.current = audio;
                    
                    audio.onended = () => setState('idle');
                    audio.onerror = () => {
                        console.warn("Google TTS failed, switching to fallback.");
                        playFallback();
                    };
                    
                    await audio.play();
                } catch (e) {
                    playFallback();
                }
            };

            const playFallback = () => {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US';
                u.rate = 0.9;
                u.onend = () => setState('idle');
                utteranceRef.current = u;
                synthRef.current.speak(u);
            };

            const pause = () => {
                if (audioRef.current && !audioRef.current.paused) {
                    audioRef.current.pause();
                    setState('paused');
                } else if (synthRef.current.speaking && !synthRef.current.paused) {
                    synthRef.current.pause();
                    setState('paused');
                }
            };

            const resume = () => {
                 if (audioRef.current && audioRef.current.paused) {
                    audioRef.current.play();
                    setState('playing');
                } else if (synthRef.current.paused) {
                    synthRef.current.resume();
                    setState('playing');
                } else {
                    play(); // If nothing to resume, start over
                }
            }

            return { state, play, pause, resume, stop };
        };

        const Popover = ({ data, type, onClose, isQuizMode }) => {
            const { state, play, pause, resume, stop } = useAudioPlayer(type === 'vocab' ? `${data.word}. ${data.ex}` : '');
            const [isRevealed, setIsRevealed] = useState(false);

            useEffect(() => {
                // Reset quiz state when data changes
                setIsRevealed(false);
                return () => stop();
            }, [data.id || data.word]);

            // Quiz Mode Logic
            const showHidden = isQuizMode && type === 'vocab' && !isRevealed;

            return (
                <div className="absolute z-50 bg-white rounded-lg shadow-xl border border-gray-200 p-4 w-80 animate-fade-in" 
                     style={{ top: '100%', left: '50%', transform: 'translate(-50%, 10px)' }}
                     onClick={(e) => e.stopPropagation()}>
                    
                    {/* Header */}
                    <div className="flex justify-between items-start mb-2">
                        <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">
                            {type === 'vocab' ? 'VOCABULARY' : 'EXAMPLE BANK'}
                        </span>
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                             &times;
                        </button>
                    </div>

                    {type === 'footnote' && (
                        <div className="space-y-2">
                            {data.map((ex, i) => (
                                <div key={i} className="p-2 bg-gray-50 rounded text-sm text-gray-700 border-l-2 border-blue-400">
                                    {ex}
                                </div>
                            ))}
                        </div>
                    )}

                    {type === 'vocab' && showHidden && (
                        <div className="text-center py-4">
                            <div className="text-sm text-gray-500 mb-1">{data.pos}</div>
                            <div className="font-bold text-lg mb-4">{data.def}</div>
                            <button 
                                onClick={() => setIsRevealed(true)}
                                className="flex items-center justify-center gap-2 w-full py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 font-bold transition-colors">
                                <Icons.Eye /> 揭曉答案
                            </button>
                        </div>
                    )}

                    {type === 'vocab' && !showHidden && (
                        <div>
                            <div className="flex justify-between items-baseline mb-1">
                                <h3 className="text-2xl font-bold text-gray-900">{data.word}</h3>
                                <span className="font-mono text-gray-500 text-sm">{data.kk}</span>
                            </div>
                            <div className="flex items-center gap-2 mb-3">
                                <span className="text-xs font-bold bg-gray-100 px-1.5 py-0.5 rounded text-gray-600">{data.pos}</span>
                                <span className="text-gray-800 font-medium">{data.def}</span>
                            </div>

                            {/* Audio Controls */}
                            <div className="flex items-center gap-2 mb-3 bg-gray-50 p-1.5 rounded-full w-max">
                                {state === 'playing' ? (
                                    <button onClick={pause} className="p-1.5 bg-white shadow rounded-full text-blue-600 hover:bg-gray-100"><Icons.Pause /></button>
                                ) : (
                                    <button onClick={state === 'paused' ? resume : play} className="p-1.5 bg-white shadow rounded-full text-blue-600 hover:bg-gray-100"><Icons.Play /></button>
                                )}
                                <button onClick={stop} className="p-1.5 text-gray-400 hover:text-red-500"><Icons.Square /></button>
                                <span className="text-xs text-gray-400 pr-2 font-medium">
                                    {state === 'playing' ? 'Playing...' : state === 'paused' ? 'Paused' : 'Listen'}
                                </span>
                            </div>

                            <div className="text-sm text-gray-600 italic border-l-2 border-gray-300 pl-2">
                                "{data.ex}"
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TextParser = ({ text, onActivate, activeId, isQuizMode }) => {
            // Tokenize: Splits by [Footnotes], [ChinesePlaceholders], Punctuation, Spaces
            const parts = text.split(/(\[\d+\]|[\u4e00-\u9fa5]+[a-zA-Z0-9\(\)\/]*|[\s\.,;!?()]+)/g).filter(Boolean);

            return (
                <p className="leading-8 text-lg text-gray-800 mb-6">
                    {parts.map((part, index) => {
                        // 1. Footnote [1]
                        if (/^\[\d+\]$/.test(part)) {
                            const id = parseInt(part.replace(/[\[\]]/g, ''));
                            const isActive = activeId === `footnote-${id}`;
                            return (
                                <span key={index} className="relative inline-block ml-1 align-super">
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); onActivate('footnote', id); }}
                                        className={`text-[10px] font-bold px-1.5 rounded cursor-pointer transition-colors ${isActive ? 'bg-[#EB5757] text-white' : 'bg-[#EB5757]/10 text-[#EB5757] hover:bg-[#EB5757]/20'}`}>
                                        {id}
                                    </button>
                                    {isActive && <Popover data={FOOTNOTE_DB[id]} type="footnote" onClose={() => onActivate(null)} isQuizMode={isQuizMode} />}
                                </span>
                            );
                        }

                        // 2. Chinese Placeholders (e.g. 描述主題的名詞)
                        if (/[\u4e00-\u9fa5]/.test(part)) {
                            return <span key={index} className="text-gray-400 font-medium mx-1 border-b border-dashed border-gray-300">{part}</span>;
                        }

                        // 3. Vocab Check (Case insensitive match)
                        const lower = part.toLowerCase();
                        if (VOCAB_DB[lower]) {
                            const isActive = activeId === `vocab-${lower}`;
                            // Quiz Mode Mask
                            if (isQuizMode) {
                                return (
                                    <span key={index} className="relative inline-block">
                                        <span 
                                            onClick={(e) => { e.stopPropagation(); onActivate('vocab', lower); }}
                                            className={`cursor-pointer border-b-2 border-[#EB5757] bg-[#EB5757]/5 px-1 mx-0.5 select-none text-transparent hover:bg-[#EB5757]/10 transition-colors`}>
                                            {part}
                                        </span>
                                        {isActive && <Popover data={{...VOCAB_DB[lower], word: part}} type="vocab" onClose={() => onActivate(null)} isQuizMode={isQuizMode} />}
                                    </span>
                                );
                            }
                            // Normal Mode
                            return (
                                <span key={index} className="relative inline-block">
                                    <span 
                                        onClick={(e) => { e.stopPropagation(); onActivate('vocab', lower); }}
                                        className={`cursor-pointer px-1 mx-0.5 rounded transition-colors ${isActive ? 'bg-[#D3E5EF] text-blue-900' : 'bg-[#E3E2E0] hover:bg-[#D3E5EF]'}`}>
                                        {part}
                                    </span>
                                    {isActive && <Popover data={{...VOCAB_DB[lower], word: part}} type="vocab" onClose={() => onActivate(null)} isQuizMode={isQuizMode} />}
                                </span>
                            );
                        }

                        // 4. Normal Text
                        return <span key={index}>{part}</span>;
                    })}
                </p>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('formula'); // 'formula' | 'essays'
            const [activePopover, setActivePopover] = useState(null); // { type, id }
            const [isQuizMode, setIsQuizMode] = useState(false);

            // Close popover on outside click
            useEffect(() => {
                const handleClickOutside = () => setActivePopover(null);
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, []);

            const handleActivate = (type, id) => {
                const key = `${type}-${id}`;
                setActivePopover(prev => prev === key ? null : key);
            };

            return (
                <div className="flex h-screen max-w-5xl mx-auto shadow-2xl bg-white overflow-hidden">
                    {/* Sidebar */}
                    <div className="w-64 bg-[#F7F7F5] border-r border-gray-200 flex flex-col flex-shrink-0">
                        <div className="p-6">
                            <h1 className="text-xl font-bold flex items-center gap-2 text-gray-800">
                                <Icons.BookOpen /> Essay Coach
                            </h1>
                        </div>
                        <nav className="flex-1 px-4 space-y-1">
                            <button 
                                onClick={() => setActiveTab('formula')}
                                className={`w-full text-left px-3 py-2 rounded-md font-medium transition-colors ${activeTab === 'formula' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:bg-gray-200'}`}>
                                萬用公式 (The Formula)
                            </button>
                            <button 
                                onClick={() => setActiveTab('essays')}
                                className={`w-full text-left px-3 py-2 rounded-md font-medium transition-colors ${activeTab === 'essays' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:bg-gray-200'}`}>
                                實戰範文 (Essays)
                            </button>
                        </nav>
                        
                        {/* Quiz Toggle */}
                        <div className="p-4 border-t border-gray-200">
                            <div className="flex items-center justify-between cursor-pointer group" onClick={() => setIsQuizMode(!isQuizMode)}>
                                <span className={`font-medium ${isQuizMode ? 'text-[#EB5757]' : 'text-gray-600'}`}>Quiz Mode</span>
                                <div className="transition-colors text-gray-400 group-hover:text-gray-600">
                                    {isQuizMode ? <Icons.ToggleRight /> : <Icons.ToggleLeft />}
                                </div>
                            </div>
                            <div className="text-xs text-gray-400 mt-2">
                                {isQuizMode ? '生字已遮蔽。點擊以揭曉。' : '點擊生字查看定義。'}
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 overflow-y-auto bg-white relative">
                        {/* Tab Content */}
                        <div className="max-w-3xl mx-auto px-12 py-12 pb-32">
                            
                            {activeTab === 'formula' && (
                                <div className="animate-fade-in">
                                    {/* Onboarding Callout */}
                                    <div className="mb-8 p-4 bg-blue-50 rounded-lg border border-blue-100 flex gap-3">
                                        <div className="text-blue-500 mt-1"><Icons.Info /></div>
                                        <div>
                                            <h3 className="font-bold text-blue-900 text-sm uppercase tracking-wide mb-2">How To Use</h3>
                                            <ul className="text-sm text-blue-800 space-y-1">
                                                <li><strong>Step 1:</strong> 閱讀樣板一遍即可。</li>
                                                <li><strong>Step 2:</strong> 閱讀範文。</li>
                                                <li><strong>Step 3:</strong> 任選一篇範文 <span className="underline decoration-blue-300">全文背誦</span>。</li>
                                            </ul>
                                            <p className="text-xs text-blue-600 mt-2 leading-relaxed">
                                                樣板就像數學公式一樣難背，範文雖然字數較多，但因為有上下文，反而容易記憶。只要範文背熟，實際應用時一定可以自然地替換掉不合的部分。
                                            </p>
                                        </div>
                                    </div>

                                    <h2 className="text-3xl font-bold mb-6 text-gray-900 border-b pb-4">萬用作文模版</h2>
                                    <TextParser 
                                        text={FORMULA_TEXT} 
                                        onActivate={handleActivate} 
                                        activeId={activePopover} 
                                        isQuizMode={isQuizMode} 
                                    />
                                </div>
                            )}

                            {activeTab === 'essays' && (
                                <div className="space-y-12 animate-fade-in">
                                    {ESSAYS_DATA.map(essay => (
                                        <div key={essay.id}>
                                            <h2 className="text-2xl font-bold mb-4 text-gray-800 sticky top-0 bg-white/95 py-2 backdrop-blur z-10">
                                                {essay.title}
                                            </h2>
                                            <TextParser 
                                                text={essay.content} 
                                                onActivate={handleActivate} 
                                                activeId={activePopover} 
                                                isQuizMode={isQuizMode} 
                                            />
                                            <hr className="my-8 border-gray-100"/>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
